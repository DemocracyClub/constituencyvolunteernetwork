<html>
<head>
    <title>Constituency Example</title>
 
    <!-- bring in the OpenLayers javascript library
         (here we bring it from the remote site, but you could
         easily serve up this javascript yourself) -->
    <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
 
    <!-- bring in the OpenStreetMap OpenLayers layers.
         Using this hosted file will make sure we are kept up
         to date with any necessary changes -->
    <script src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script>
 
    <script type="text/javascript">
        // Start position for the map (hardcoded here for simplicity)
        var lat=53;
        var lon=-1;
        var zoom=5;

        OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
            defaultHandlerOptions: {
                'single': true,
                'double': false,
                'pixelTolerance': 0,
                'stopSingle': false,
                'stopDouble': false
            },
            initialize: function(options) {
               this.handlerOptions = OpenLayers.Util.extend(
                    {}, this.defaultHandlerOptions
                );
               OpenLayers.Control.prototype.initialize.apply(
                   this, arguments
                ); 
                this.handler = new OpenLayers.Handler.Click(
                    this, {
                       'click': this.trigger
                    }, this.handlerOptions
                );
            }, 

            trigger: function(e) {
                var lonlat = map.getLonLatFromViewPortPx(e.xy).transform(new OpenLayers.Projection("EPSG:900913"));
                function handler(request) {
                    if (request.status == 200) {
                        popup = new OpenLayers.Popup("popup",
                                                     new OpenLayers.LonLat(lonlat.lon,lonlat.lat),
                                                     new OpenLayers.Size(200,200),
                                                     request.responseText,
                                                     true);
                        map.addPopup(popup);
                        }
                }

                var request = OpenLayers.Request.GET({
                    url: '{% url boundaries.views.popup "id"%}/' + lonlat.lon + '/' + lonlat.lat,
                    callback: handler
                });
            }

            });

 
        var map; //complex object of type OpenLayers.Map
 
        //Initialise the 'map' object
        function init() {
            map = new OpenLayers.Map ("map", {
                controls:[
                    new OpenLayers.Control.Navigation(),
                    new OpenLayers.Control.PanZoomBar(),
                    new OpenLayers.Control.Attribution(),
                    new OpenLayers.Control.LayerSwitcher()],
                maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
                maxResolution: 156543.0399,
                numZoomLevels: 19,
                units: 'm',
                projection: new OpenLayers.Projection("EPSG:900913"),
                displayProjection: new OpenLayers.Projection("EPSG:900913")
            } );

		
            // Define the map layer
            // Other defined layers are OpenLayers.Layer.OSM.Mapnik, OpenLayers.Layer.OSM.Maplint and OpenLayers.Layer.OSM.CycleMap
            layer = new OpenLayers.Layer.OSM( "Open Street Map");
            map.addLayer(layer);
            cyclemap = new OpenLayers.Layer.OSM.CycleMap("Cycle Map");
            map.addLayer(cyclemap);


            //Custom layer
            custom = new OpenLayers.Layer.TMS("Constituencies",
                       "{% url boundaries.views.tile "id"%}",
                       { 'type':'png', 'getURL':get_my_url, transparent: 'true', isBaseLayer: false});
            map.addLayer(custom);

            var click = new OpenLayers.Control.Click();
            map.addControl(click);
            click.activate();

 
            if( ! map.getCenter() ){
                var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
                map.setCenter (lonLat, zoom);
            }
        }

        function get_my_url (bounds) {
            var res = this.map.getResolution();
            var x = Math.round ((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
            var y = Math.round ((this.maxExtent.top - bounds.top) / (res * this.tileSize.h));
            var z = this.map.getZoom();
    
            var path = z + "/" + x + "/" + y + "." + this.type;
            var url = this.url;
            if (url instanceof Array) {
                url = this.selectUrl(path, url);
            }
            return url + path;

        }
    </script>

</head>
 
<!-- body.onload is called once the page is loaded (call the 'init' function) -->
<body onload="init();">
 
    <!-- define a DIV into which the map will appear. Make it take up the whole window -->
    <div style="width:100%; height:100%" id="map"></div>
 
</body>
 
</html>
